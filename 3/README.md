# Verilog线性和非线性拆分系统

这是一个基于DFG（数据流图）的Verilog代码线性和非线性拆分系统，旨在将组合逻辑电路最优地分配到光学神经网络（ONN）和传统电子电路两个部分。

## 项目概述

本系统通过分析Verilog代码的DFG表示，计算线性程度，并使用模拟退火算法和神经网络架构搜索（NAS）两种方法同时进行优化搜索，找到最优的拆分方案。

### 线性操作定义
- **线性操作**：加法、减法、常数乘法、移位、位选择、连接运算
- **非线性操作**：乘法、除法、逻辑运算、比较运算、条件运算

### 系统架构
```
DFG文件 → 解析器 → 线性程度分析 → 优化算法 → 接口生成 → 结果输出
                ↓
            成本函数评估 ← 模拟退火 + NAS
```

## 功能特性

### 1. DFG解析与分析
- 自动解析DFG文件格式
- 识别操作符类型（线性/非线性）
- 计算线性程度比例
- 构建有向图结构

### 2. 多算法优化
- **模拟退火算法**：全局搜索最优分区方案
- **神经网络架构搜索（NAS）**：基于进化的架构优化
- 支持多种邻域操作和温度调度策略

### 3. 智能成本函数
- 面积成本：ONN和电子部分的面积估算
- 延迟成本：关键路径延迟分析
- 误差成本：ONN精度损失评估
- 复杂度成本：分区平衡性评估
- 接口成本：跨分区数据传输开销

### 4. 自动接口生成
- 生成ONN和电子部分之间的接口定义
- 自动识别跨分区信号
- 生成完整的Verilog接口模块
- 包含测试台代码

### 5. 结果可视化
- DFG结构图可视化
- 分区结果展示
- 优化过程历史曲线
- 节点分布统计图

## 安装与依赖

### 系统要求
- Python 3.8+
- Linux/Windows/macOS

### 安装依赖
```bash
pip install -r requirements.txt
```

### 主要依赖包
- `numpy`: 数值计算
- `networkx`: 图论算法
- `matplotlib`: 数据可视化
- `torch`: 深度学习框架（NAS模块）
- `scipy`: 科学计算

## 使用方法

### 1. 基本使用
```bash
# 使用默认配置运行
python src/main.py

# 指定DFG文件
python src/main.py --dfg path/to/your/dfg.txt

# 指定输出目录
python src/main.py --output results/

# 使用自定义配置文件
python src/main.py --config config.json
```

### 2. 配置文件
系统支持JSON格式的配置文件，可以自定义：
- 优化算法参数
- 成本函数权重
- ONN和电子电路参数
- 接口协议设置

### 3. 输出结果
系统会在输出目录中生成：
- `partition_result.json`: 分区结果
- `optimization_results.json`: 优化过程数据
- `interfaces/`: 接口代码目录
- `partition_visualization.png`: 可视化结果

## 项目结构

```
project/
├── src/                    # 源代码目录
│   ├── __init__.py
│   ├── main.py            # 主程序
│   ├── dfg_parser.py      # DFG解析器
│   ├── cost_function.py   # 成本函数
│   ├── simulated_annealing.py  # 模拟退火算法
│   ├── neural_architecture_search.py  # NAS算法
│   └── interface_generator.py  # 接口生成器
├── dfg_files/             # DFG文件目录
│   └── 4004_dfg.txt      # 示例DFG文件
├── config.json            # 配置文件
├── requirements.txt        # 依赖包列表
├── rule.md                # 项目需求说明
└── README.md              # 项目说明文档
```

## 算法原理

### 1. 线性程度计算
```
线性程度 = 线性节点数 / 总节点数
```

### 2. 模拟退火算法
- **状态表示**：二进制向量s=[s₁,s₂,...,sₙ]，sᵢ=1表示节点i分配给ONN
- **邻域操作**：随机翻转、节点交换、聚类操作
- **接受准则**：Metropolis准则，P(接受) = exp(-ΔE/T)

### 3. 神经网络架构搜索
- **种群初始化**：随机生成架构种群
- **适应度评估**：基于成本函数计算适应度
- **进化操作**：选择、交叉、变异
- **精英保留**：保留最优个体

### 4. 成本函数
```
总成本 = w₁×面积 + w₂×延迟 + w₃×误差 + w₄×复杂度 + w₅×接口
```

## 性能优化

### 1. 算法优化
- 自适应温度调度
- 多线程并行计算
- 早期终止条件
- 缓存优化

### 2. 内存管理
- 图结构压缩
- 中间结果缓存
- 垃圾回收优化

## 扩展功能

### 1. 支持更多DFG格式
- Verilog AST解析
- 其他HDL格式支持
- 自定义DFG格式

### 2. 高级优化算法
- 遗传算法
- 粒子群优化
- 强化学习

### 3. 硬件实现支持
- FPGA综合
- ASIC设计流程
- 物理设计约束

## 故障排除

### 常见问题

1. **DFG解析失败**
   - 检查文件格式是否正确
   - 确认文件编码为UTF-8
   - 验证DFG语法

2. **优化不收敛**
   - 调整温度参数
   - 增加迭代次数
   - 检查成本函数权重

3. **内存不足**
   - 减少种群大小
   - 降低图复杂度
   - 使用分批处理

### 调试模式
```bash
# 启用详细日志
export PYTHONPATH=src
python -m src.main --debug
```

## 贡献指南

欢迎贡献代码和提出建议！

### 开发环境设置
```bash
git clone <repository>
cd verilog-partitioner
pip install -r requirements.txt
pip install -e .
```

### 代码规范
- 遵循PEP 8规范
- 添加类型注解
- 编写单元测试
- 更新文档

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交Issue
- 发送邮件
- 参与讨论

## 更新日志

### v1.0.0 (2024-01-01)
- 初始版本发布
- 支持基本的DFG解析和优化
- 实现模拟退火和NAS算法
- 自动接口生成功能

---

**注意**：本系统仍在开发中，部分功能可能不够完善。建议在生产环境中使用前进行充分测试。 